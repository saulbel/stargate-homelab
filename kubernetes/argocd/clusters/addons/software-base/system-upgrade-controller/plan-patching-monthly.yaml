# Example Plan CRD for system-upgrade-controller (TESTING - every 10 minutes)
# This Plan uses spec.upgrade container to run patching commands
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: os-patching-test-10min
  namespace: system-upgrade
spec:
  concurrency: 1
  # Schedule: every 10 minutes (testing only)
  version: "ubuntu-22.04"
  schedule: "*/10 * * * *"
  nodeSelector:
    kubernetes.io/os: linux
  description: "TEST: OS package patching (apt) â€” every 10 minutes for validation"
  
  # Node preparation (optional)
  prepare:
    image: ubuntu:22.04
    command:
      - /bin/sh
    args:
      - -c
      - |
        echo "Preparing node for patching..."
        apt-get update || true
  
  # Main upgrade/patching container
  upgrade:
    image: ubuntu:22.04
    command:
      - /bin/sh
    args:
      - -c
      - |
        echo "=== Starting OS patching ==="
        apt-get update
        echo "Checking available upgrades..."
        apt-get upgrade -s | grep "^Inst" || echo "No upgrades available"
        
        if apt-get upgrade -s | grep -q "^Inst"; then
          echo "Applying upgrades..."
          apt-get -y upgrade
        else
          echo "System is up-to-date, no upgrades needed"
        fi
        
        echo "=== Patching complete ==="
  
  # Drain configuration
  drain:
    deleteEmptydirData: true
    ignoreDaemonSets: true
    force: true
    timeout: 10m
  
  # Cordon the node during patching
  cordon: true