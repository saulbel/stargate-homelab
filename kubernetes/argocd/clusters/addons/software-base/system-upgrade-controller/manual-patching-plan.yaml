# Production Plan CRD - OS Patching (manual trigger, no schedule)
# Deploy to: kubernetes/argocd/clusters/addons/software-base/system-upgrade-controller/
# Trigger: kubectl annotate plan os-patching-manual -n system-upgrade system-upgrade.cattle.io/force=true --overwrite
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: os-patching-manual
  namespace: system-upgrade
spec:
  concurrency: 1
  # Schedule: every 10 minutes (testing only)
  # schedule: "*/10 * * * *"
  #schedule: "0 0 1 1 0"
  version: "ubuntu-22.04"
  nodeSelector:
    kubernetes.io/os: linux
  description: "Production: OS package patching (apt) â€” manual on-demand execution"
  
  prepare:
    image: ubuntu:22.04
    command:
      - /bin/sh
    args:
      - -c
      - |
        echo "Preparing node for patching..."
        apt-get update || true
  
  upgrade:
    image: ubuntu:22.04
    command:
      - /bin/sh
    args:
      - -c
      - |
        echo "=== OS Patching Started ==="
        date
        apt-get update
        echo "Available updates:"
        apt-get upgrade -s | grep "^Inst" || echo "No upgrades available"
        
        if apt-get upgrade -s | grep -q "^Inst"; then
          echo "Installing updates..."
          apt-get -y upgrade
          echo "Updates installed successfully"
        else
          echo "System is already up-to-date"
        fi
        
        echo "=== Patching Completed ==="
        date
  
  drain:
    deleteEmptydirData: true
    ignoreDaemonSets: true
    force: true
    timeout: 15m
  
  cordon: true
  postCompleteDelay: "30s"